{% extends "base.html" %}
{% block title %}{{ process.process_number }}{% endblock %}
{% block content %}
<div class="header-row">
    <h1>External Process: {{ process.process_number }}</h1>
    <div>
        {% if process.status in ['sent', 'in_progress', 'partial'] and process.quantity_returned < process.quantity_sent %}
        <a href="{{ url_for('external_processes.receive', id=process.id) }}" class="btn btn-success">
            <i class="fas fa-box-open"></i> Receive Items
        </a>
        <a href="{{ url_for('receipts.new') }}" class="btn btn-primary">
            <i class="fas fa-inbox"></i> Create Reception
        </a>
        <a href="{{ url_for('external_processes.edit', id=process.id) }}" class="btn btn-info">
            <i class="fas fa-edit"></i> Edit
        </a>
        <a href="{{ url_for('external_processes.cancel', id=process.id) }}" class="btn btn-danger" 
           onclick="return confirm('Cancel this external process?')">
            <i class="fas fa-ban"></i> Cancel
        </a>
        {% endif %}
        <a href="{{ url_for('external_processes.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="section">
    <h2>Process Information</h2>
    <div class="row">
        <div class="col-md-6">
            <table class="table table-bordered">
                <tr>
                    <th style="width: 40%;">Process Number:</th>
                    <td><strong>{{ process.process_number }}</strong></td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>
                        {% if process.status == 'sent' %}
                        <span class="badge badge-primary">Sent</span>
                        {% elif process.status == 'in_progress' %}
                        <span class="badge badge-warning">In Progress</span>
                        {% elif process.status == 'partial' %}
                        <span class="badge badge-info">Partially Returned</span>
                        {% elif process.status == 'completed' %}
                        <span class="badge badge-success">Completed</span>
                        {% elif process.status == 'cancelled' %}
                        <span class="badge badge-danger">Cancelled</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Item:</th>
                    <td>
                        <a href="{{ url_for('items.view', id=process.item.id) }}">
                            {{ process.item.sku }} - {{ process.item.name }}
                        </a>
                    </td>
                </tr>
                <tr>
                    <th>Supplier:</th>
                    <td>{{ process.supplier.name }}</td>
                </tr>
                <tr>
                    <th>Process Type:</th>
                    <td>{{ process.process_type }}</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <table class="table table-bordered">
                <tr>
                    <th style="width: 40%;">Quantity Sent:</th>
                    <td><strong>{{ process.quantity_sent }}</strong></td>
                </tr>
                <tr>
                    <th>Quantity Returned:</th>
                    <td><strong>{{ process.quantity_returned }}</strong></td>
                </tr>
                <tr>
                    <th>Remaining:</th>
                    <td>
                        <strong class="{% if process.quantity_returned >= process.quantity_sent %}text-success{% else %}text-primary{% endif %}">
                            {{ process.quantity_sent - process.quantity_returned }}
                        </strong>
                    </td>
                </tr>
                <tr>
                    <th>Cost:</th>
                    <td>â‚¬{{ "%.2f"|format(process.cost) }}</td>
                </tr>
                <tr>
                    <th>Sent Date:</th>
                    <td>{{ process.sent_date.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <h3>Timeline</h3>
            <table class="table table-bordered">
                <tr>
                    <th style="width: 40%;">Sent On:</th>
                    <td>{{ process.sent_date.strftime('%Y-%m-%d') }}</td>
                </tr>
                <tr>
                    <th>Expected Return:</th>
                    <td>
                        {% if process.expected_return %}
                            {{ process.expected_return.strftime('%Y-%m-%d') }}
                            {% set days_diff = (process.expected_return.date() - process.sent_date.date()).days %}
                            {% if days_diff < 0 %}
                                <span class="badge badge-danger">Overdue</span>
                            {% elif days_diff == 0 %}
                                <span class="badge badge-warning">Due Today</span>
                            {% elif days_diff <= 3 %}
                                <span class="badge badge-warning">Due Soon</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Actual Return:</th>
                    <td>
                        {% if process.actual_return %}
                            {{ process.actual_return.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            <span class="text-muted">Not yet returned</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <h3>Progress</h3>
            <div class="progress" style="height: 30px;">
                {% set progress_percent = (process.quantity_returned / process.quantity_sent * 100) | int %}
                <div class="progress-bar {% if progress_percent == 100 %}bg-success{% else %}bg-primary{% endif %}" 
                     role="progressbar" 
                     style="width: {{ progress_percent }}%"
                     aria-valuenow="{{ progress_percent }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    {{ progress_percent }}% Returned
                </div>
            </div>
            <p class="mt-2 text-muted">
                {{ process.quantity_returned }} of {{ process.quantity_sent }} items returned
            </p>
        </div>
    </div>

    {% if process.notes %}
    <div class="mt-3">
        <h3>Notes</h3>
        <div class="alert alert-info">
            {{ process.notes }}
        </div>
    </div>
    {% endif %}
</div>

{% if process.status in ['sent', 'in_progress', 'partial'] and process.quantity_returned < process.quantity_sent %}
<div class="section">
    <h2>Next Steps</h2>
    <div class="alert alert-primary">
        <strong>To receive items from this external process:</strong>
        <ol class="mb-0">
            <li><strong>Option 1 (Quick):</strong> Click the "Receive Items" button above for simple reception without scrap tracking</li>
            <li><strong>Option 2 (Recommended):</strong> Use <a href="{{ url_for('receipts.new') }}">Create Reception</a> 
                and select "External Process Return" to track scrap quantities if any items are damaged</li>
        </ol>
    </div>
</div>
{% endif %}

<style>
.badge {
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
}
.badge-primary { background-color: #007bff; color: white; }
.badge-success { background-color: #28a745; color: white; }
.badge-warning { background-color: #ffc107; color: black; }
.badge-danger { background-color: #dc3545; color: white; }
.badge-info { background-color: #17a2b8; color: white; }
.progress {
    border: 1px solid #ddd;
}
</style>
{% endblock %}
