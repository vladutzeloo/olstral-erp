{% extends "base.html" %}
{% block title %}New Scrap Record{% endblock %}
{% block content %}
<h1>Create New Scrap Record</h1>
<div class="section">
    <form method="POST" id="scrapForm">
        <div class="form-group">
            <label>Location *</label>
            <select name="location_id" id="location_id" class="form-control" required>
                <option value="">Select Location</option>
                {% for location in locations %}
                <option value="{{ location.id }}">{{ location.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Item *</label>
            <input type="hidden" name="item_id" id="item_id" required>
            <input type="text" id="item_search" class="form-control" 
                   placeholder="Type SKU or name to search..." 
                   autocomplete="off" required>
            <div id="search-results" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; width:95%; margin-top:2px;"></div>
            <small class="text-muted">Search and select an item from the location above</small>
        </div>

        <div class="form-group">
            <label>Quantity *</label>
            <input type="number" name="quantity" id="quantity" class="form-control" 
                   placeholder="Quantity to scrap" min="1" required>
            <small class="text-muted" id="available-qty"></small>
        </div>

        <div class="form-group">
            <label>Reason *</label>
            <select name="reason" id="reason" class="form-control" required>
                <option value="">Select Reason</option>
                <option value="Damaged">Damaged</option>
                <option value="Defective">Defective</option>
                <option value="Expired">Expired</option>
                <option value="Quality Issue">Quality Issue</option>
                <option value="Contaminated">Contaminated</option>
                <option value="Obsolete">Obsolete</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Notes</label>
            <textarea name="notes" class="form-control" rows="3" 
                      placeholder="Additional details about the scrap..."></textarea>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Create Scrap Record
            </button>
            <a href="{{ url_for('scraps.index') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<style>
#search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    background: white;
    position: absolute;
    z-index: 1000;
    width: 95%;
    margin-top: 2px;
}
#search-results div {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
#search-results div:hover {
    background-color: #f0f0f0;
}
</style>

<script>
let searchTimeout;
let selectedItemAvailable = 0;

// Location change handler
document.getElementById('location_id').addEventListener('change', function() {
    // Clear item selection when location changes
    document.getElementById('item_id').value = '';
    document.getElementById('item_search').value = '';
    document.getElementById('available-qty').textContent = '';
    document.getElementById('search-results').style.display = 'none';
});

// Item search handler
document.getElementById('item_search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    const locationId = document.getElementById('location_id').value;
    
    if (!locationId) {
        alert('Please select a location first');
        this.value = '';
        return;
    }
    
    if (query.length < 2) {
        document.getElementById('search-results').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`/scraps/search_items?q=${encodeURIComponent(query)}&location_id=${locationId}`)
            .then(response => response.json())
            .then(items => {
                const resultsDiv = document.getElementById('search-results');
                
                if (items.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 8px; color: #666;">No items found at this location</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                resultsDiv.innerHTML = items.map(item => 
                    `<div data-id="${item.id}" data-label="${item.label}" data-available="${item.available || 0}">${item.label}</div>`
                ).join('');
                resultsDiv.style.display = 'block';
                
                resultsDiv.querySelectorAll('div').forEach(div => {
                    div.addEventListener('click', function() {
                        document.getElementById('item_id').value = this.dataset.id;
                        document.getElementById('item_search').value = this.dataset.label;
                        selectedItemAvailable = parseInt(this.dataset.available) || 0;
                        document.getElementById('available-qty').textContent = 
                            `Available quantity at location: ${selectedItemAvailable}`;
                        document.getElementById('quantity').max = selectedItemAvailable;
                        resultsDiv.style.display = 'none';
                    });
                });
            });
    }, 300);
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#item_search') && !e.target.closest('#search-results')) {
        document.getElementById('search-results').style.display = 'none';
    }
});

// Form validation
document.getElementById('scrapForm').addEventListener('submit', function(e) {
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    
    if (quantity > selectedItemAvailable) {
        e.preventDefault();
        alert(`Quantity cannot exceed available quantity (${selectedItemAvailable})`);
        return false;
    }
    
    if (quantity <= 0) {
        e.preventDefault();
        alert('Please enter a valid quantity');
        return false;
    }
});
</script>
{% endblock %}
