{% extends "base.html" %}
{% block title %}{{ order.order_number }}{% endblock %}
{% block content %}
<div class="header-row">
    <h1>Production Order: {{ order.order_number }}</h1>
    <div>
        {% if order.status == 'draft' %}
        <form method="POST" action="{{ url_for('production_orders.release', id=order.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-primary">Release Order</button>
        </form>
        {% elif order.status == 'released' %}
        <form method="POST" action="{{ url_for('production_orders.start', id=order.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-success">Start Production</button>
        </form>
        {% elif order.status == 'in_progress' %}
        <a href="{{ url_for('production_orders.complete', id=order.id) }}" class="btn btn-success">Complete Production</a>
        {% endif %}

        {% if order.status in ['draft', 'released'] %}
        <form method="POST" action="{{ url_for('production_orders.cancel', id=order.id) }}"
              style="display:inline;"
              onsubmit="return confirm('Are you sure you want to cancel this production order?');">
            <button type="submit" class="btn btn-danger">Cancel</button>
        </form>
        {% endif %}

        <a href="{{ url_for('production_orders.index') }}" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<div class="section">
    <h2>Order Details</h2>
    <div class="row">
        <div class="col-md-6">
            <table class="table table-bordered">
                <tr>
                    <th style="width: 40%;">Order Number:</th>
                    <td>{{ order.order_number }}</td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td><span class="badge badge-{{ order.status }}">{{ order.status.replace('_', ' ').title() }}</span></td>
                </tr>
                <tr>
                    <th>Finished Item:</th>
                    <td>
                        <a href="{{ url_for('items.view', id=order.finished_item_id) }}">
                            {{ order.finished_item.sku }} - {{ order.finished_item.name }}
                        </a>
                    </td>
                </tr>
                <tr>
                    <th>BOM:</th>
                    <td>
                        {% if order.bom_id %}
                        <a href="{{ url_for('bom.view', id=order.bom_id) }}">
                            {{ order.bom.bom_number }} (v{{ order.bom.version }})
                        </a>
                        {% else %}
                        <span class="badge badge-secondary">Manual Components</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Location:</th>
                    <td>{{ order.location.name }}</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <table class="table table-bordered">
                <tr>
                    <th style="width: 40%;">Quantity Ordered:</th>
                    <td>{{ order.quantity_ordered }}</td>
                </tr>
                <tr>
                    <th>Quantity Produced:</th>
                    <td><strong>{{ order.quantity_produced }}</strong></td>
                </tr>
                <tr>
                    <th>Quantity Scrapped:</th>
                    <td>{% if order.quantity_scrapped > 0 %}<span class="badge badge-danger">{{ order.quantity_scrapped }}</span>{% else %}0{% endif %}</td>
                </tr>
                <tr>
                    <th>Completion:</th>
                    <td>
                        <div style="background-color: #e9ecef; border-radius: 4px; height: 20px; overflow: hidden;">
                            <div style="background-color: #28a745; height: 100%; width: {{ order.get_completion_percentage() }}%;"></div>
                        </div>
                        {{ "%.1f"|format(order.get_completion_percentage()) }}%
                    </td>
                </tr>
                <tr>
                    <th>Start Date:</th>
                    <td>{% if order.start_date %}{{ order.start_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Due Date:</th>
                    <td>{% if order.due_date %}{{ order.due_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                </tr>
            </table>
        </div>
    </div>

    {% if order.actual_start_date or order.actual_completion_date %}
    <div class="mt-3">
        <h3>Production Timeline</h3>
        <table class="table table-bordered">
            <tr>
                <th style="width: 20%;">Actual Start:</th>
                <td>{% if order.actual_start_date %}{{ order.actual_start_date.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}</td>
            </tr>
            <tr>
                <th>Actual Completion:</th>
                <td>{% if order.actual_completion_date %}{{ order.actual_completion_date.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}</td>
            </tr>
        </table>
    </div>
    {% endif %}

    {% if order.notes %}
    <div class="mt-3">
        <h3>Notes</h3>
        <div class="alert alert-info">
            {{ order.notes }}
        </div>
    </div>
    {% endif %}
</div>

<div class="section">
    <h2>{% if order.bom_id %}BOM Components{% else %}Raw Materials / Components{% endif %}</h2>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Qty per Unit</th>
                    <th>Total Required</th>
                    <th>UOM</th>
                </tr>
            </thead>
            <tbody>
                {% if order.bom_id %}
                    {% for component in order.bom.components %}
                    <tr>
                        <td>
                            <a href="{{ url_for('items.view', id=component.component_item_id) }}">
                                {{ component.component.sku }} - {{ component.component.name }}
                            </a>
                        </td>
                        <td>{{ component.quantity }}</td>
                        <td><strong>{{ component.quantity * order.quantity_ordered }}</strong></td>
                        <td>{{ component.unit_of_measure or component.component.unit_of_measure }}</td>
                    </tr>
                    {% endfor %}
                {% elif order.manual_components %}
                    {% set manual_comps = order.manual_components|from_json %}
                    {% for comp in manual_comps %}
                    {% set item = comp.item_id|item_by_id %}
                    <tr>
                        <td>
                            <a href="{{ url_for('items.view', id=comp.item_id) }}">
                                {{ item.sku }} - {{ item.name }}
                            </a>
                        </td>
                        <td>{{ comp.quantity }}</td>
                        <td><strong>{{ comp.quantity * order.quantity_ordered }}</strong></td>
                        <td>{{ item.unit_of_measure }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% if picking_list %}
<div class="section">
    <h2>üìã Material Picking List</h2>
    <p class="text-muted">Gather these materials from the warehouse bins before starting production</p>

    {% for pick_item in picking_list %}
    <div class="card mb-3">
        <div class="card-header" style="background-color: #f8f9fa;">
            <h4 style="margin: 0;">
                {{ pick_item.item.sku }} - {{ pick_item.item.name }}
            </h4>
            <div style="margin-top: 5px;">
                <span class="badge badge-primary">Need: {{ pick_item.quantity_needed }}</span>
                <span class="badge badge-{% if pick_item.total_available >= pick_item.quantity_needed %}success{% else %}danger{% endif %}">
                    Available: {{ pick_item.total_available }}
                </span>
            </div>
        </div>
        <div class="card-body">
            {% if pick_item.location_bins %}
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th style="width: 18%;">Warehouse Location</th>
                        <th style="width: 15%;">Bin Location</th>
                        <th style="width: 25%;">Batch Numbers</th>
                        <th style="width: 12%;">Quantity</th>
                        <th style="width: 12%;">Received Date</th>
                        <th style="width: 18%;">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loc_bin in pick_item.location_bins %}
                    <tr {% if loc_bin.is_production_location %}style="background-color: #e7f3ff;"{% endif %}>
                        <td>
                            <strong style="font-size: 1.0em; {% if loc_bin.is_production_location %}color: #28a745;{% else %}color: #333;{% endif %}">
                                {{ loc_bin.location_name }}
                                {% if loc_bin.is_production_location %}
                                <span class="badge badge-success">Production</span>
                                {% endif %}
                            </strong>
                        </td>
                        <td>
                            <strong style="font-size: 1.0em; {% if loc_bin.bin_location != 'Unassigned' %}color: #007bff;{% else %}color: #6c757d;{% endif %}">
                                {{ loc_bin.bin_location }}
                            </strong>
                        </td>
                        <td>
                            {% for batch in loc_bin.batches[:3] %}
                            <span class="badge badge-secondary">{{ batch.batch_number }}</span>
                            {% endfor %}
                            {% if loc_bin.batches|length > 3 %}
                            <span class="text-muted">+{{ loc_bin.batches|length - 3 }} more</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ loc_bin.total_quantity }}</strong></td>
                        <td>
                            {% if loc_bin.batches %}
                            {{ loc_bin.batches[0].received_date.strftime('%Y-%m-%d') }}
                            {% endif %}
                        </td>
                        <td class="text-muted">
                            {% if loc_bin.is_production_location %}
                            Already at production
                            {% elif loc_bin.bin_location == 'Unassigned' %}
                            No bin assigned
                            {% else %}
                            Will auto-transfer
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è No batches available</strong> - Cannot start production without materials
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div class="alert alert-info">
        <strong>üí° How it works:</strong>
        <ul class="mb-0">
            <li>This picking list shows where materials are currently located across all warehouse locations</li>
            <li>When you click "Start Production", the system will <strong>automatically transfer</strong> materials from other locations to the production area</li>
            <li>Materials are then consumed using FIFO (First In, First Out) method</li>
            <li>Items highlighted in blue are already at the production location</li>
        </ul>
    </div>
</div>
{% endif %}

{% if order.status in ['in_progress', 'completed'] and order.consumption_records %}
<div class="section">
    <h2>Component Consumption (FIFO)</h2>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Batch</th>
                    <th>Bin Location</th>
                    <th>Qty Consumed</th>
                    <th>Cost per Unit</th>
                    <th>Total Cost</th>
                    <th>Consumed Date</th>
                </tr>
            </thead>
            <tbody>
                {% for consumption in order.consumption_records %}
                <tr>
                    <td>{{ consumption.component.sku }} - {{ consumption.component.name }}</td>
                    <td>
                        <a href="{{ url_for('batches.view', id=consumption.batch_id) }}">
                            {{ consumption.batch.batch_number }}
                        </a>
                    </td>
                    <td>
                        {% if consumption.batch.bin_location %}
                            <span class="badge badge-info">{{ consumption.batch.bin_location }}</span>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>{{ consumption.quantity_consumed }}</td>
                    <td>${{ "%.2f"|format(consumption.cost_per_unit) }}</td>
                    <td><strong>${{ "%.2f"|format(consumption.total_cost) }}</strong></td>
                    <td>{{ consumption.consumed_date.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
                <tr class="table-active">
                    <td colspan="5"><strong>Total Material Cost (FIFO):</strong></td>
                    <td colspan="2"><strong>${{ "%.2f"|format(order.material_cost) }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if order.status == 'completed' %}
<div class="section">
    <h2>Production Cost Summary</h2>
    <table class="table table-bordered" style="max-width: 500px;">
        <tr>
            <th style="width: 60%;">Material Cost (FIFO):</th>
            <td>${{ "%.2f"|format(order.material_cost) }}</td>
        </tr>
        <tr>
            <th>Labor Cost:</th>
            <td>${{ "%.2f"|format(order.labor_cost) }}</td>
        </tr>
        <tr>
            <th>Overhead Cost:</th>
            <td>${{ "%.2f"|format(order.overhead_cost) }}</td>
        </tr>
        <tr class="table-active">
            <th><strong>Total Production Cost:</strong></th>
            <td><strong>${{ "%.2f"|format(order.total_cost) }}</strong></td>
        </tr>
        {% if order.quantity_produced > 0 %}
        <tr class="table-active">
            <th><strong>Cost per Unit:</strong></th>
            <td><strong>${{ "%.2f"|format(order.total_cost / order.quantity_produced) }}</strong></td>
        </tr>
        {% endif %}
    </table>
</div>
{% endif %}

{% if traceability %}
<div class="section">
    <h2>Batch Traceability</h2>
    <div class="alert alert-info">
        <strong>Forward Traceability:</strong> You can trace which finished goods batches were created from this production order.
    </div>
    <div class="alert alert-info">
        <strong>Backward Traceability:</strong> You can trace which raw material batches were consumed to produce the finished goods.
    </div>
</div>
{% endif %}

<style>
.badge {
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
}
.badge-draft {
    background-color: #95a5a6;
    color: white;
}
.badge-released {
    background-color: #3498db;
    color: white;
}
.badge-in_progress {
    background-color: #f39c12;
    color: white;
}
.badge-completed {
    background-color: #28a745;
    color: white;
}
.badge-cancelled {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}
