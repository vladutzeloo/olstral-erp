{% extends "base.html" %}
{% block title %}New Receipt{% endblock %}
{% block content %}
<h1>Create New Receipt</h1>
<div class="section">
    <form method="POST" id="receiptForm">
        <div class="form-group">
            <label>Reception Source *</label>
            <select name="source_type" id="source_type" class="form-control" required>
                <option value="purchase_order">Purchase Order</option>
                <option value="production">Production (Internal Order)</option>
                <option value="external_process">External Process Return</option>
            </select>
        </div>

        <div class="form-group" id="po_section">
            <label>Purchase Order (optional)</label>
            <select name="po_id" id="po_id" class="form-control">
                <option value="">None - Manual Entry</option>
                {% for po in pos %}
                <option value="{{ po.id }}">
                    {{ po.po_number }} - {{ po.supplier.name }}
                </option>
                {% endfor %}
            </select>
            <small class="text-muted">Select a PO to auto-populate items, or leave blank for manual entry</small>
        </div>

        <div class="form-group" id="production_section" style="display:none;">
            <label>Internal Order Number *</label>
            <input type="text" name="internal_order_number" id="internal_order_number" class="form-control" 
                   placeholder="e.g., PROD-2024-001">
            <small class="text-muted">Track items received from production</small>
        </div>

        <div class="form-group" id="external_process_section" style="display:none;">
            <label>External Process *</label>
            <select name="external_process_id" id="external_process_id" class="form-control">
                <option value="">Select External Process</option>
                {% for ep in external_processes %}
                <option value="{{ ep.id }}" 
                        data-item-id="{{ ep.item_id }}" 
                        data-item-sku="{{ ep.item.sku }}"
                        data-item-name="{{ ep.item.name }}"
                        data-remaining="{{ ep.quantity_sent - ep.quantity_returned }}">
                    {{ ep.process_number }} - {{ ep.item.sku }} - {{ ep.supplier.name }}
                    ({{ ep.quantity_sent - ep.quantity_returned }} remaining)
                </option>
                {% endfor %}
            </select>
            <small class="text-muted">Receive items returning from external processing</small>
        </div>

        <div class="form-group">
            <label>Location *</label>
            <select name="location_id" id="location_id" class="form-control" required>
                <option value="">Select Location</option>
                {% for location in locations %}
                <option value="{{ location.id }}">{{ location.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="items-container">
            <h3>Items</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Item</th>
                            <th style="width: 15%;">Supplier Batch #</th>
                            <th style="width: 12%;">Qty Received</th>
                            <th style="width: 12%;">Qty Scrap</th>
                            <th style="width: 12%;">Good Qty</th>
                            <th style="width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="item-rows">
                        <tr class="item-row">
                            <td>
                                <input type="hidden" name="item_id[]" class="item-id-input">
                                <input type="text" class="form-control item-search"
                                       placeholder="Type SKU or name to search..."
                                       autocomplete="off">
                                <div class="search-results" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; width:90%;"></div>
                            </td>
                            <td>
                                <input type="text" name="supplier_batch_number[]" class="form-control supplier-batch"
                                       placeholder="Optional" autocomplete="off">
                            </td>
                            <td>
                                <input type="number" name="quantity[]" class="form-control qty-received"
                                       placeholder="Received" min="0" value="0">
                            </td>
                            <td>
                                <input type="number" name="scrap_quantity[]" class="form-control qty-scrap"
                                       placeholder="Scrap" min="0" value="0">
                            </td>
                            <td>
                                <input type="number" class="form-control qty-good"
                                       placeholder="Good" readonly style="background-color: #e9ecef;">
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm remove-row" onclick="removeRow(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-secondary" onclick="addItemRow()">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>

        <div class="form-group mt-3">
            <label>Notes</label>
            <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-check"></i> Create Receipt
            </button>
            <a href="{{ url_for('receipts.index') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<style>
.search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    background: white;
    position: absolute;
    z-index: 1000;
    width: 90%;
}
.search-results div {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.search-results div:hover {
    background-color: #f0f0f0;
}
.item-row td {
    vertical-align: middle;
}
</style>

<script>
// Source type change handler
document.getElementById('source_type').addEventListener('change', function() {
    const sourceType = this.value;
    const poSection = document.getElementById('po_section');
    const prodSection = document.getElementById('production_section');
    const extSection = document.getElementById('external_process_section');
    const poSelect = document.getElementById('po_id');
    const prodInput = document.getElementById('internal_order_number');
    const extSelect = document.getElementById('external_process_id');
    
    // Hide all sections and clear required
    poSection.style.display = 'none';
    prodSection.style.display = 'none';
    extSection.style.display = 'none';
    poSelect.removeAttribute('required');
    prodInput.removeAttribute('required');
    extSelect.removeAttribute('required');
    
    // Show relevant section
    if (sourceType === 'purchase_order') {
        poSection.style.display = 'block';
    } else if (sourceType === 'production') {
        prodSection.style.display = 'block';
        prodInput.setAttribute('required', 'required');
    } else if (sourceType === 'external_process') {
        extSection.style.display = 'block';
        extSelect.setAttribute('required', 'required');
    }
    
    // Clear items when source changes
    clearAllRows();
    addItemRow();
});

// PO selection handler with AJAX
document.getElementById('po_id').addEventListener('change', function() {
    const poId = this.value;

    if (!poId) {
        clearAllRows();
        addItemRow();
        return;
    }

    console.log('Loading items for PO:', poId);

    // Show loading indicator
    const originalHtml = this.parentElement.querySelector('small').innerHTML;
    this.parentElement.querySelector('small').innerHTML = 'Loading items...';

    fetch(`/receipts/api/po_items/${poId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load PO items');
            }
            return response.json();
        })
        .then(data => {
            console.log('PO items loaded:', data);

            if (data.success && data.items && data.items.length > 0) {
                clearAllRows();
                data.items.forEach(item => {
                    console.log(`Adding item: ${item.sku}, remaining: ${item.remaining}`);
                    addItemRowWithData(
                        item.item_id,
                        item.sku,
                        item.name,
                        item.remaining
                    );
                });
            } else {
                alert('No items found for this PO');
            }

            // Restore original text
            this.parentElement.querySelector('small').innerHTML = originalHtml;
        })
        .catch(error => {
            console.error('Error loading PO items:', error);
            alert('Error loading PO items. Please try again later.');

            // Restore original text
            this.parentElement.querySelector('small').innerHTML = originalHtml;
        });
});

// External process selection handler with AJAX
document.getElementById('external_process_id').addEventListener('change', function() {
    const processId = this.value;

    if (!processId) {
        clearAllRows();
        addItemRow();
        return;
    }

    console.log('Loading external process info:', processId);

    // Show loading indicator
    const originalHtml = this.parentElement.querySelector('small').innerHTML;
    this.parentElement.querySelector('small').innerHTML = 'Loading process details...';

    fetch(`/receipts/get_external_process_info/${processId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load external process info');
            }
            return response.json();
        })
        .then(data => {
            console.log('External process loaded:', data);

            clearAllRows();

            // Use receive_item (which handles transformation correctly)
            addItemRowWithData(
                data.receive_item.id,
                data.receive_item.sku,
                data.receive_item.name,
                data.remaining
            );

            // Show transformation note if applicable
            if (data.transformation_note) {
                const noteTextarea = document.querySelector('textarea[name="notes"]');
                noteTextarea.value = data.transformation_note;
            }

            // Restore original text
            this.parentElement.querySelector('small').innerHTML = originalHtml;
        })
        .catch(error => {
            console.error('Error loading external process:', error);
            alert('Error loading external process details. Please try again.');

            // Restore original text
            this.parentElement.querySelector('small').innerHTML = originalHtml;
        });
});

function addItemRow() {
    const tbody = document.getElementById('item-rows');
    const firstRow = tbody.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('input').forEach(input => {
        if (input.type === 'number') {
            input.value = '0';
        } else {
            input.value = '';
        }
    });
    
    tbody.appendChild(newRow);
    attachRowHandlers(newRow);
}

function addItemRowWithData(itemId, sku, name, quantity) {
    const tbody = document.getElementById('item-rows');
    const firstRow = tbody.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    
    newRow.querySelector('.item-id-input').value = itemId;
    newRow.querySelector('.item-search').value = `${sku} - ${name}`;
    newRow.querySelector('.qty-received').value = quantity || 0;
    newRow.querySelector('.qty-scrap').value = 0;
    updateGoodQty(newRow);
    
    if (tbody.children.length === 1 && !tbody.children[0].querySelector('.item-id-input').value) {
        tbody.innerHTML = '';
    }
    
    tbody.appendChild(newRow);
    attachRowHandlers(newRow);
}

function clearAllRows() {
    const tbody = document.getElementById('item-rows');
    tbody.innerHTML = '';
}

function removeRow(button) {
    const tbody = document.getElementById('item-rows');
    if (tbody.children.length > 1) {
        button.closest('tr').remove();
    } else {
        alert('At least one item row is required');
    }
}

function updateGoodQty(row) {
    const received = parseInt(row.querySelector('.qty-received').value) || 0;
    const scrap = parseInt(row.querySelector('.qty-scrap').value) || 0;
    const good = Math.max(0, received - scrap);
    row.querySelector('.qty-good').value = good;
}

function attachRowHandlers(row) {
    const searchInput = row.querySelector('.item-search');
    const resultsDiv = row.querySelector('.search-results');
    const itemIdInput = row.querySelector('.item-id-input');
    const qtyReceived = row.querySelector('.qty-received');
    const qtyScrap = row.querySelector('.qty-scrap');
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/receipts/search_items?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(items => {
                    if (items.length === 0) {
                        resultsDiv.innerHTML = '<div style="padding: 8px; color: #666;">No items found</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }
                    
                    resultsDiv.innerHTML = items.map(item => 
                        `<div data-id="${item.id}" data-label="${item.label}">${item.label}</div>`
                    ).join('');
                    resultsDiv.style.display = 'block';
                    
                    resultsDiv.querySelectorAll('div').forEach(div => {
                        div.addEventListener('click', function() {
                            itemIdInput.value = this.dataset.id;
                            searchInput.value = this.dataset.label;
                            resultsDiv.style.display = 'none';
                        });
                    });
                });
        }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!row.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
    
    // Update good quantity when received or scrap changes
    qtyReceived.addEventListener('input', () => updateGoodQty(row));
    qtyScrap.addEventListener('input', () => updateGoodQty(row));
}

// Initialize handlers for existing rows
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.item-row').forEach(row => {
        attachRowHandlers(row);
    });
});

// Form validation
document.getElementById('receiptForm').addEventListener('submit', function(e) {
    const rows = document.querySelectorAll('.item-row');
    let hasValidItem = false;
    
    rows.forEach(row => {
        const itemId = row.querySelector('.item-id-input').value;
        const qty = parseInt(row.querySelector('.qty-received').value) || 0;
        
        if (itemId && qty > 0) {
            hasValidItem = true;
        }
    });
    
    if (!hasValidItem) {
        e.preventDefault();
        alert('Please add at least one item with quantity greater than 0');
        return false;
    }
});
</script>
{% endblock %}
